<section class="mt-6" cdkDropListGroup>
  <ng-container *ngIf="(columns$ | async) as columns">
    <ng-container *ngIf="(tasks$ | async) as tasksList">

      <div
        cdkDropList
        [cdkDropListData]="columns"
        cdkDropListOrientation="horizontal"
        (cdkDropListDropped)="onDropColumns($event)"
        class="grid [grid-template-columns:repeat(auto-fit,minmax(320px,1fr))] gap-5 sm:gap-6 xl:gap-8"
      >

        <ng-container *ngFor="let col of columns; trackBy: trackCol">
          <article
            cdkDrag
            cdkDragLockAxis="x"
            [cdkDragDisabled]="editingColumnId === col.id"
            class="min-w-0 flex flex-col h-[60vh] sm:h-[65vh] lg:h-[70vh] rounded-2xl bg-white ring-1 ring-black/5 shadow-sm overflow-hidden"
          >
            <div class="px-4 sm:px-5 pt-5 pb-3" [id]="'col-header-'+col.id">
  <!-- fila fija: nunca wrapping -->
  <div class="flex items-center justify-between gap-2 flex-nowrap">
    <!-- izq: handle + dot + título/input + contador -->
    <div class="flex items-center gap-2 flex-1 min-w-0 overflow-hidden">
      <button
        type="button"
        cdkDragHandle
        class="p-1 rounded hover:bg-slate-100 cursor-grab active:cursor-grabbing shrink-0"
        title="Arrastrar columna"
        aria-label="Arrastrar columna">
        <i class="fas fa-grip-vertical text-slate-400"></i>
      </button>

      <span class="h-2.5 w-2.5 rounded-full shrink-0" [style.background]="col.color"></span>

      <!-- título (una línea, ellipsis) -->
      <h2 *ngIf="editingColumnId !== col.id"
          class="text-lg font-bold text-slate-800 truncate">
        {{ col.title }}
      </h2>

      <!-- input de edición: no empuja, ocupa lo que quede -->
      <input *ngIf="editingColumnId === col.id"
             [id]="'col-input-' + col.id"
             [(ngModel)]="editTitle"
             [readonly]="col.isCore"
             class="w-0 flex-1 min-w-0 rounded-lg border border-slate-300 px-2 py-1 text-lg font-bold text-slate-800
                    focus:outline-none focus:ring-2 focus:ring-teal-600 focus:border-teal-600
                    [readonly]:cursor-not-allowed [readonly]:bg-slate-50"
             (keydown.enter)="$event.preventDefault(); commitColumnInline()"
             (keydown.escape)="cancelColumnInline()" />

      <!-- contador compacto, no se colapsa -->
      <span class="text-slate-500 text-sm shrink-0 tabular-nums">
        ({{ tasksOf(col, tasksList).length }})
      </span>
    </div>

    <!-- der: menú, anclado y sin wrap -->
    <div class="relative shrink-0">
      <button class="p-2 rounded hover:bg-slate-100" (click)="toggleColMenu(col.id, $event)">
        <i class="fas fa-ellipsis-v text-slate-500"></i>
      </button>

      <div *ngIf="openColumnMenuId === col.id"
           class="col-menu absolute right-0 mt-2 z-50"
           (click)="$event.stopPropagation()">
        <div class="rounded-xl bg-white shadow-xl ring-1 ring-black/5 overflow-hidden min-w-44">
          <button class="w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-slate-50"
                  (click)="startAdd(col.id); closeColMenus()">
            <i class="fas fa-plus text-slate-500"></i> <span>Añadir tarea</span>
          </button>
          <button class="w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-slate-50"
                  (click)="$event.stopPropagation(); renameColumn(col)">
            <i class="far fa-edit text-slate-500"></i><span>Renombrar columna</span>
          </button>
          <div class="h-px bg-slate-100"></div>
          <button class="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50"
                  *ngIf="!col.isCore" (click)="deleteColumn(col)">
            <i class="far fa-trash-alt"></i><span>Eliminar columna</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- descripción abajo (no afecta a la fila superior) -->
  <p *ngIf="editingColumnId !== col.id"
     class="text-slate-500 text-sm mt-1 break-words line-clamp-2">
    {{ col.description }}
  </p>

  <!-- edición avanzada -->
  <div *ngIf="editingColumnId === col.id" class="mt-2 space-y-2">
    <div class="flex items-center gap-3 flex-wrap">
      <label class="text-sm text-slate-600">Color:</label>
      <input type="color" [(ngModel)]="editColor" class="shrink-0" />
      <span class="h-4 w-4 rounded-full border border-slate-200 shrink-0" [style.background]="editColor"></span>
    </div>

    <input [(ngModel)]="editDesc" type="text"
           class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-800
                  focus:outline-none focus:ring-2 focus:ring-teal-600 focus:border-teal-600"
           placeholder="Descripción de la columna"
           (keydown.enter)="$event.preventDefault(); commitColumnInline()"
           (keydown.escape)="cancelColumnInline()" />

    <p class="text-[11px] text-slate-400">
      Enter para guardar · Esc para cancelar · Click fuera para guardar
    </p>
  </div>
</div>

            <div
              class="flex-1 overflow-y-auto px-4 sm:px-5 pb-4 space-y-3"
              cdkDropList
              [id]="col.id"
              [cdkDropListData]="tasksOf(col, tasksList)"
              [cdkDropListConnectedTo]="connectedTo(columns)"
              (cdkDropListDropped)="onTaskDrop($event)"
            >
              <p *ngIf="tasksOf(col, tasksList).length === 0" class="text-slate-400 text-sm text-center mt-8">
                No hay tareas en esta columna.
              </p>

              <ng-container *ngFor="let task of tasksOf(col, tasksList); trackBy: trackById">
                <div
                  cdkDrag
                  [cdkDragData]="task"
                  class="group relative rounded-lg border border-slate-200 bg-white px-3.5 py-2.5 hover:bg-slate-50 hover:shadow-sm transition cursor-grab active:cursor-grabbing"
                >
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex-1 min-w-0">
                      <p
                        class="text-sm font-medium text-slate-800 cursor-pointer hover:underline break-words"
                        (click)="openModal(task)"
                      >
                        {{ task.text }}
                      </p>

                      <p class="mt-1.5 text-[11px] text-slate-500 flex items-center gap-1.5">
                        <i class="far fa-clock"></i>
                        <ng-container *ngIf="task.updatedAt; else createdOnly">
                          Actualizada: {{ task.updatedAt | date:'dd/MM/yyyy HH:mm' }}
                        </ng-container>
                        <ng-template #createdOnly>
                          Creada: {{ task.createdAt | date:'dd/MM/yyyy HH:mm' }}
                        </ng-template>
                      </p>
                    </div>
                    <div class="relative shrink-0">
                      <button
                        class="ctx-btn p-1 rounded hover:bg-slate-100 cursor-pointer"
                        (mousedown)="$event.stopPropagation()"
                        (click)="openMenu(task.id, $event)"
                        aria-label="Abrir menú de tarea"
                      >
                        <i class="fas fa-ellipsis-h text-slate-500 text-[13px]"></i>
                      </button>

                      <div *ngIf="selectedTaskId === task.id" class="ctx-menu absolute right-0 mt-2 z-50">
                        <div class="rounded-xl bg-white shadow-xl ring-1 ring-black/5 overflow-hidden min-w-40">
                          <button
                            class="w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-slate-50"
                            (click)="openModal(task)"
                          >
                            <i class="far fa-edit text-slate-500"></i><span>Editar</span>
                          </button>
                          <div class="h-px bg-slate-100"></div>
                          <button
                            class="w-full flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50"
                            (click)="deleteTask(task)"
                          >
                            <i class="far fa-trash-alt"></i><span>Eliminar</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <ng-template cdkDragPreview>
                    <div class="rounded-lg ring-1 ring-black/5 shadow bg-white px-3 py-2 transition-none">
                      {{ task.text }}
                    </div>
                  </ng-template>
                </div>
              </ng-container>
            </div>

            <ng-container *ngIf="addingForId !== col.id; else addForm">
              <div class="border-t">
                <button
                  type="button"
                  (click)="startAdd(col.id)"
                  aria-label="Agregar tarea"
                  class="w-full group flex items-center gap-3 px-5 py-4 text-sm font-semibold text-slate-700
                         hover:bg-slate-50 hover:text-teal-700 cursor-pointer transition-colors
                         focus:outline-none focus-visible:ring-2 focus-visible:ring-teal-600
                         focus-visible:ring-offset-2 focus-visible:ring-offset-white"
                >
                  <span
                    class="inline-flex h-6 w-6 items-center justify-center rounded-md bg-slate-100 group-hover:bg-teal-600 transition-colors"
                  >
                    <span class="text-base leading-none group-hover:text-white">+</span>
                  </span>
                  <span>Agregar tarea</span>
                  <i
                    class="fas fa-plus ml-auto opacity-0 group-hover:opacity-100 group-hover:rotate-90 transition-all duration-200"
                  ></i>
                </button>
              </div>
            </ng-container>

            <ng-template #addForm>
              <div class="px-4 sm:px-5 py-4 border-t">
                <div class="rounded-xl ring-1 ring-slate-200 bg-white shadow-sm p-3">
                  <div class="flex flex-wrap items-center gap-2">
                    <span class="h-2.5 w-2.5 rounded-full shrink-0" [style.background]="col.color"></span>
                    <input
                      [(ngModel)]="newTaskTitle"
                      (keyup.enter)="addTask(col.id)"
                      type="text"
                      placeholder="Escribe el título de la nueva tarea…"
                      class="min-w-0 flex-1 bg-transparent text-sm text-slate-800 placeholder-slate-400 focus:outline-none"
                    />
                    <button
                      type="button"
                      (click)="cancelAdd()"
                      aria-label="Cancelar"
                      class="h-9 w-9 grid place-items-center rounded-lg hover:bg-slate-100 text-slate-600 shrink-0"
                    >
                      <i class="fas fa-times text-sm"></i>
                    </button>
                    <button
                      type="button"
                      (click)="addTask(col.id)"
                      [disabled]="!newTaskTitle"
                      class="h-9 px-4 rounded-lg text-white text-sm font-semibold hover:brightness-95
                             disabled:opacity-50 disabled:cursor-not-allowed shrink-0"
                      [style.background]="col.color"
                    >
                      Añadir
                    </button>
                  </div>
                </div>
              </div>
            </ng-template>
          </article>
        </ng-container>

        <article
          class="min-w-0 flex flex-col h-[60vh] sm:h-[65vh] lg:h-[70vh] rounded-2xl bg-slate-50 ring-1 ring-dashed ring-slate-300/70 shadow-sm overflow-hidden items-center justify-center"
        >
          <div *ngIf="!showNewColumnForm; else newColForm" class="text-slate-600">
            <button class="inline-flex items-center gap-2 px-4 py-2 rounded-xl hover:bg-slate-100" (click)="showNewColumnForm = true">
              <span class="text-teal-700 text-xl leading-none">+</span>
              <span class="font-semibold">Añadir nueva columna</span>
            </button>
          </div>

          <ng-template #newColForm>
            <div class="w-[min(92%,320px)]">
              <label class="block text-sm text-slate-600 mb-1">Nombre de la columna</label>
              <input
                [(ngModel)]="newColumnName"
                (keyup.enter)="addColumn()"
                type="text"
                class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm
                       focus:outline-none focus:ring-2 focus:ring-teal-600 focus:border-teal-600"
              />

              <div class="mt-3 flex items-center gap-3 flex-wrap">
                <label class="text-sm text-slate-600">Color del indicador</label>
                <input type="color" [(ngModel)]="newColumnColor" class="shrink-0">
                <span class="h-4 w-4 rounded-full border border-slate-200 shrink-0" [style.background]="newColumnColor"></span>
              </div>

              <div class="mt-3">
                <label class="block text-sm text-slate-600 mb-1">Descripción</label>
                <input
                  [(ngModel)]="newColumnDescription"
                  type="text"
                  class="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm
                         focus:outline-none focus:ring-2 focus:ring-teal-600 focus:border-teal-600"
                  placeholder="Nueva columna de tareas"
                />
              </div>

              <div class="mt-3 flex items-center justify-end gap-2 flex-wrap">
                <button
                  class="px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-700"
                  (click)="showNewColumnForm=false; newColumnName=''; newColumnDescription='Nueva columna de tareas'; newColumnColor='#94a3b8'"
                >
                  Cancelar
                </button>
                <button
                  class="px-3 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700 disabled:opacity-50"
                  [disabled]="!newColumnName.trim()"
                  (click)="addColumn()"
                >
                  Crear
                </button>
              </div>
            </div>
          </ng-template>
        </article>
      </div>
    </ng-container>
  </ng-container>
</section>

<!-- Modal -->
<div *ngIf="modal">
  <app-modal [task]="selectedTask" [visible]="modal" (closeModal)="modal = false"></app-modal>
</div>